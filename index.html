<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>é«”æ„Ÿå¹«é«˜èª¿éŠæˆ²ç³»çµ±</title>
<!-- å¼•å…¥ Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    :root {
        --c-cyan: #00f3ff; --c-gold: #ffd700; --c-danger: #ff3b3b;
        --c-heal: #39ff14; --c-super: #ff00ff; /* è¶…é«˜èª¿é¡è‰² */
        --c-dark: #020205; --c-panel: rgba(10, 15, 20, 0.9);
    }
    body {
        margin: 0; background: var(--c-dark); color: #fff;
        font-family: 'Segoe UI', sans-serif; overflow: hidden;
        height: 100vh; width: 100vw; user-select: none;
    }

    /* å®¹å™¨è¨­å®š */
    #game-wrapper { position: absolute; inset: 0; }
    
    /* é¡åƒå±¤ï¼šé¡¯ç¤º Video å’Œ å‹•æ…‹è»Œè·¡ (ç¿»è½‰) */
    #mirror-layer { 
        position: absolute; inset: 0; 
        transform: scaleX(-1); 
        z-index: 1; 
    }
    
    /* éŠæˆ²å±¤ï¼šé¡¯ç¤ºæ‰è½ç‰©å’ŒUIæ–‡å­— (ä¸ç¿»è½‰) */
    #game-canvas { 
        position: absolute; inset: 0; 
        z-index: 2; 
    }

    video { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0.8; }
    canvas { position: absolute; inset: 0; width: 100%; height: 100%; }

    /* èƒŒæ™¯ç¶²æ ¼ */
    .grid-bg {
        position: absolute; inset: 0; z-index: 0;
        background-image: linear-gradient(#ffd70010 1px, transparent 1px),
                          linear-gradient(90deg, #ffd70010 1px, transparent 1px);
        background-size: 50px 50px; pointer-events: none;
    }

    /* UI å±¤ */
    #ui-layer {
        position: absolute; inset: 0; z-index: 10; pointer-events: none;
        display: flex; flex-direction: column; justify-content: space-between;
    }

    /* é ‚éƒ¨è³‡è¨Šåˆ— */
    #top-bar {
        padding: 20px; display: flex; justify-content: space-between; align-items: center;
        background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
        font-weight: bold; font-size: 24px; text-shadow: 0 0 10px #000;
        opacity: 0; transition: 0.5s; pointer-events: auto;
    }
    .left-group { display: flex; gap: 20px; align-items: center; }
    .score-box { color: var(--c-cyan); display: flex; gap: 10px; align-items: center; }
    .score-val { font-size: 32px; color: #fff; font-family: 'Courier New', monospace; }
    
    .lives-box { color: var(--c-danger); display: flex; gap: 5px; }
    .heart { color: var(--c-danger); animation: beat 1s infinite; }
    @keyframes beat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }

    /* éœéŸ³æŒ‰éˆ• */
    #sound-btn {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: #fff; padding: 5px 10px; border-radius: 5px;
        cursor: pointer; font-size: 18px; transition: 0.3s;
    }
    #sound-btn:hover { background: rgba(255, 255, 255, 0.3); }

    /* å•Ÿå‹•/çµæŸé¢æ¿ */
    .panel {
        position: absolute; top: 50%; left: 50%; 
        transform: translate(-50%, -50%);
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        background: var(--c-panel); border: 2px solid var(--c-gold);
        padding: 40px 60px; 
        backdrop-filter: blur(10px); z-index: 20;
        box-shadow: 0 0 50px rgba(255, 215, 0, 0.3); 
        border-radius: 15px; text-align: center;
        transition: 0.3s; pointer-events: auto;
        width: auto; max-width: 90%;
    }
    .panel h1 { 
        font-size: clamp(1.2rem, 6vw, 3rem); 
        white-space: nowrap;
        color: var(--c-gold); 
        margin: 0 0 10px 0; text-transform: uppercase;
        text-shadow: 0 0 20px var(--c-gold);
    }
    .panel p { color: #fff; margin-bottom: 30px; font-size: 1.2rem; line-height: 1.6; }
    .highlight { color: var(--c-gold); font-weight: bold; }
    .highlight-2 { color: var(--c-cyan); font-weight: bold; }
    .highlight-3 { color: var(--c-super); font-weight: bold; }
    .danger-text { color: var(--c-danger); font-weight: bold; }
    .heal-text { color: var(--c-heal); font-weight: bold; }

    /* æŒ‰éˆ•æ¨£å¼ */
    .btn {
        background: linear-gradient(45deg, #ffae00, #ffd700);
        border: none; color: #000;
        padding: 15px 50px; font-size: 20px; font-weight: 800;
        cursor: pointer; clip-path: polygon(15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%, 0 15px);
        transition: 0.2s; box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
    }
    .btn:hover { transform: scale(1.05); filter: brightness(1.2); }
    .btn:active { transform: scale(0.95); }

    .hidden { display: none !important; }

    /* --- å‰ç¥¥ç‰©æ¨£å¼ --- */
    .mascot-container {
        position: absolute; bottom: 40px; left: 20px;
        width: 120px; height: auto;
        z-index: 30; pointer-events: auto;
        transition: transform 0.2s;
    }
    .mascot-container img {
        width: 100%; display: block;
        filter: drop-shadow(0 0 5px rgba(0,0,0,0.5));
        transition: filter 0.2s;
    }
    .mascot-container:hover img {
        animation: neon-shake 0.4s infinite linear;
    }
    @keyframes neon-shake {
        0% { transform: translate(1px, 1px); }
        25% { transform: translate(-1px, -1px); }
        50% { transform: translate(-1px, 1px); }
        75% { transform: translate(1px, -1px); }
        100% { transform: translate(1px, 1px); }
    }

    /* --- ç‰ˆæ¬Šé å°¾ --- */
    .footer {
        position: absolute; bottom: 10px; width: 100%;
        text-align: center; color: rgba(255, 255, 255, 0.6);
        font-size: 12px; letter-spacing: 1px;
        text-shadow: 0 1px 2px #000;
        pointer-events: none; z-index: 25;
    }

    /* æ‰‹æ©Ÿé©é… */
    @media (max-width: 768px) {
        .panel { width: 90%; padding: 30px 10px; }
        #top-bar { padding: 10px 15px; flex-direction: row; flex-wrap: wrap; }
        .score-box { font-size: 18px; }
        .score-val { font-size: 24px; }
        .mascot-container { width: 80px; bottom: 35px; left: 10px; }
        .footer { font-size: 10px; bottom: 5px; }
    }
</style>
</head>
<body>
    <div class="grid-bg"></div>
    
    <div id="game-wrapper">
        <!-- é¡åƒå±¤ï¼šé¡¯ç¤ºè¦–è¨Šèˆ‡å‹•æ…‹æ•æ‰çš„å…‰é» -->
        <div id="mirror-layer">
            <video id="vid" autoplay playsinline muted></video>
            <canvas id="motion-cvs"></canvas>
        </div>
        <!-- éŠæˆ²å±¤ï¼šé¡¯ç¤ºæ‰è½ç‰©ã€ç‰¹æ•ˆã€åˆ†æ•¸ (ä¸é¡åƒ) -->
        <canvas id="game-canvas"></canvas>
    </div>
    
    <div id="ui-layer">
        <div id="top-bar">
            <div class="left-group">
                <!-- éœéŸ³é–‹é—œ -->
                <button id="sound-btn" onclick="toggleMute()"><i class="fas fa-volume-up"></i></button>
                <div class="score-box">
                    <i class="fas fa-star"></i> <span class="score-val" id="scoreDisplay">0</span>
                </div>
            </div>
            <div class="lives-box" id="livesDisplay">
                <i class="fas fa-heart heart"></i><i class="fas fa-heart heart"></i><i class="fas fa-heart heart"></i>
            </div>
        </div>

        <!-- å‰ç¥¥ç‰© -->
        <div class="mascot-container" title="Chill Guy">
            <img src="image/LiyuChillGuy.svg" onerror="this.src='https://upload.wikimedia.org/wikipedia/commons/thumb/4/47/React.svg/512px-React.svg.png'" alt="LiyuChillGuy">
        </div>

        <!-- é å°¾ -->
        <div class="footer">Copyright Â© Liyuchiutiger Gongminshen</div>

        <!-- å•Ÿå‹•ç•«é¢ -->
        <div class="panel" id="start-panel">
            <h1>é«”æ„Ÿå¹«é«˜èª¿éŠæˆ²ç³»çµ±</h1>
            <p style="text-align: left; display: inline-block;">
                <span style="color:red; font-weight:bold;">âš ï¸ æ³¨æ„æ³¨æ„ï¼Œè€é«˜æ„›çš„è¿«é™ï¼Œæº–å‚™æ¥æ‹› âš ï¸</span><br><br>
                ï¼ƒæ¥ä½è€é«˜å¹«é«˜èª¿ï¼š<br>
                <span class="highlight">ğŸ’° ï¼ˆå¸¥è€é«˜ï¼‰é«˜èª¿</span> (æ™®é€š)<br>
                <span class="highlight-2">ğŸ’ ï¼ˆå¤ªé™½è€é«˜ï¼‰çœŸé«˜èª¿</span> (é«˜ç´š)<br>
                <span class="highlight-3">ğŸ”¥ ï¼ˆåŒ—æ¥µç†Šè€é«˜ï¼‰è¶…é«˜èª¿</span> (è¶…ç¨€æœ‰)<br>
                <br>
                é¿é–‹ç‚¸å½ˆ <span class="danger-text">ğŸ’£</span> / æ„›å¿ƒ <span class="heal-text">ğŸ’–</span> è£œè¡€
            </p>
            <br>
            <button class="btn" onclick="initGame()">é–‹å§‹å¹«é«˜èª¿ START</button>
        </div>

        <!-- çµæŸç•«é¢ -->
        <div class="panel hidden" id="game-over-panel">
            <h1>GAME OVER</h1>
            <p>å¹«é«˜èª¿æŒ‡æ•¸</p>
            <h2 style="font-size: 4rem; margin: 0 0 30px; color: #fff;" id="final-score">0</h2>
            <button class="btn" onclick="restartGame()">å†ç©ä¸€æ¬¡ RESTART</button>
        </div>
    </div>

    <script>
        const $ = id => document.getElementById(id);
        const vid = $('vid');
        const mCvs = $('motion-cvs'), mCtx = mCvs.getContext('2d');
        const gCvs = $('game-canvas'), gCtx = gCvs.getContext('2d');
        const tmpCvs = document.createElement('canvas'), tmpCtx = tmpCvs.getContext('2d', { willReadFrequently: true });
        
        let w, h, ch;
        let prevData = null;
        let gameActive = false;
        let score = 0;
        let lives = 3;
        const MAX_LIVES = 5; 
        let items = []; 
        let particles = [];
        let floatingTexts = []; // æ–°å¢ï¼šæµ®å‹•æ–‡å­—é™£åˆ—
        let motionPoints = []; 
        let animationFrameId;

        // --- é è¼‰å…¥åœ–ç‰‡ ---
        const imgKao1 = new Image(); imgKao1.src = 'image/happy-kao01.png';
        const imgKao2 = new Image(); imgKao2.src = 'image/happy-kao02.png';
        const imgKao3 = new Image(); imgKao3.src = 'image/happy-kao03.png'; // æ–°å¢

        // --- éŸ³æ•ˆç®¡ç†å™¨ ---
        class SoundManager {
            constructor() {
                this.ctx = null;
                this.muted = false;
                this.masterGain = null;
            }

            init() {
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                    this.masterGain = this.ctx.createGain();
                    this.masterGain.gain.value = 0.3; 
                    this.masterGain.connect(this.ctx.destination);
                } else if (this.ctx.state === 'suspended') {
                    this.ctx.resume();
                }
            }

            toggleMute() {
                this.muted = !this.muted;
                const btn = $('sound-btn').querySelector('i');
                if(this.muted) {
                    if(this.masterGain) this.masterGain.gain.setValueAtTime(0, this.ctx.currentTime);
                    btn.className = 'fas fa-volume-mute';
                } else {
                    if(this.masterGain) this.masterGain.gain.setValueAtTime(0.3, this.ctx.currentTime);
                    btn.className = 'fas fa-volume-up';
                }
            }

            playTone(freq, type, duration, slideTo = null) {
                if (!this.ctx || this.muted) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                if (slideTo) {
                    osc.frequency.linearRampToValueAtTime(slideTo, this.ctx.currentTime + duration);
                }

                gain.gain.setValueAtTime(0.5, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);

                osc.connect(gain);
                gain.connect(this.masterGain);
                
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            }

            playCoin() { this.playTone(1200, 'sine', 0.1); }
            playDiamond() { 
                this.playTone(1500, 'sine', 0.1); 
                setTimeout(() => this.playTone(2000, 'sine', 0.2), 100);
            }
            // è¶…é«˜èª¿éŸ³æ•ˆ (é¡ä¼¼é–‹å§‹éŸ³æ•ˆï¼Œæ›´è¯éº—ä¸€é»)
            playSuper() {
                this.playTone(523, 'triangle', 0.1); // C5
                setTimeout(() => this.playTone(659, 'triangle', 0.1), 80); // E5
                setTimeout(() => this.playTone(783, 'triangle', 0.1), 160); // G5
                setTimeout(() => this.playTone(1046, 'sine', 0.4), 240); // C6
            }
            playBomb() { this.playTone(150, 'sawtooth', 0.4, 10); } 
            playHeal() { this.playTone(400, 'triangle', 0.3, 800); } 
            playStart() {
                this.playTone(440, 'sine', 0.2); 
                setTimeout(() => this.playTone(554, 'sine', 0.2), 100); 
                setTimeout(() => this.playTone(659, 'sine', 0.4), 200); 
            }
            playGameOver() {
                this.playTone(440, 'triangle', 0.3);
                setTimeout(() => this.playTone(415, 'triangle', 0.3), 300);
                setTimeout(() => this.playTone(392, 'triangle', 0.8), 600);
            }
        }

        const sfx = new SoundManager();

        // èª¿æ•´é›£åº¦è¨­å®šï¼šå¯†é›†ã€å¿«é€Ÿ
        const CFG = {
            cw: 64, 
            thresh: 25, 
            spawnRate: 12, // åˆå§‹ç”Ÿæˆé–“éš”ç¸®çŸ­ (åŸæœ¬40) -> æ‰æ›´å¤š
            gravity: 6,    // åˆå§‹é€Ÿåº¦åŠ å¿« (åŸæœ¬4) -> æ‰æ›´å¿«
            hitRadius: 40 
        };

        // --- æ‰è½ç‰©é¡åˆ¥ ---
        class Item {
            constructor() {
                this.r = Math.random();
                this.img = null;
                this.type = '';
                
                // æ©Ÿç‡åˆ†ä½ˆèª¿æ•´
                if (this.r > 0.97) { 
                    this.type = 'heart'; this.val = 0; this.icon = 'ğŸ’–'; this.speed = CFG.gravity * 1.2; 
                }
                else if (this.r > 0.92) { 
                    // è¶…é«˜èª¿ (ç¨€æœ‰)
                    this.type = 'kao03'; this.val = 100; this.img = imgKao3; this.speed = CFG.gravity * 2.0; 
                }
                else if (this.r > 0.80) { 
                    // çœŸé«˜èª¿
                    this.type = 'kao02'; this.val = 50; this.img = imgKao2; this.speed = CFG.gravity * 1.5; 
                }
                else if (this.r > 0.60) { 
                    this.type = 'bomb'; this.val = -1; this.icon = 'ğŸ’£'; this.speed = CFG.gravity * 0.8; 
                }
                else { 
                    // é«˜èª¿ (æ™®é€š)
                    this.type = 'kao01'; this.val = 10; this.img = imgKao1; this.speed = CFG.gravity; 
                }
                
                this.size = 50; 
                this.x = Math.random() * (w - 60) + 30;
                this.y = -50;
                this.active = true;
                this.angle = 0;
                this.rotSpeed = (Math.random() - 0.5) * 0.1;
            }
            update() {
                this.y += this.speed;
                this.angle += this.rotSpeed;
                if (this.y > h) this.active = false;
            }
            draw(ctx) {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.angle);
                
                if (this.img) {
                    try {
                        ctx.drawImage(this.img, -this.size/2, -this.size/2, this.size, this.size);
                    } catch(e) {
                        ctx.fillStyle = this.type === 'kao03' ? '#ff00ff' : (this.type === 'kao02' ? '#00f3ff' : '#ffd700');
                        ctx.beginPath();
                        ctx.arc(0, 0, this.size/2, 0, Math.PI*2);
                        ctx.fill();
                    }
                } else {
                    ctx.font = `${this.size}px Arial`;
                    ctx.textAlign = "center";
                    ctx.textBaseline = "middle";
                    ctx.fillText(this.icon, 0, 0);
                }
                ctx.restore();
            }
        }

        // --- æµ®å‹•æ–‡å­—ç‰¹æ•ˆé¡åˆ¥ ---
        class FloatingText {
            constructor(x, y, text, color, fontSize = 30) {
                this.x = x; this.y = y;
                this.text = text; this.color = color;
                this.life = 1.0;
                this.vy = -3; // å‘ä¸Šé£„
                this.fontSize = fontSize;
            }
            update() {
                this.y += this.vy;
                this.life -= 0.02;
            }
            draw(ctx) {
                ctx.save();
                ctx.globalAlpha = Math.max(0, this.life);
                ctx.font = `bold ${this.fontSize}px 'Microsoft JhengHei', sans-serif`;
                ctx.textAlign = "center";
                ctx.fillStyle = this.color;
                ctx.strokeStyle = "black";
                ctx.lineWidth = 4;
                ctx.lineJoin = "round";
                ctx.strokeText(this.text, this.x, this.y);
                ctx.fillText(this.text, this.x, this.y);
                ctx.restore();
            }
        }

        // --- ç²’å­ç‰¹æ•ˆé¡åˆ¥ ---
        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y;
                this.vx = (Math.random() - 0.5) * 10;
                this.vy = (Math.random() - 0.5) * 10;
                this.life = 1.0;
                this.color = color;
            }
            update() {
                this.x += this.vx; this.y += this.vy;
                this.life -= 0.05;
            }
            draw(ctx) {
                ctx.globalAlpha = this.life;
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, 5, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1.0;
            }
        }

        const resize = () => {
            w = window.innerWidth;
            h = window.innerHeight;
            [mCvs, gCvs].forEach(c => { c.width = w; c.height = h; });
            if (vid.videoWidth) {
                ch = Math.floor(CFG.cw * (vid.videoHeight / vid.videoWidth));
                tmpCvs.width = CFG.cw; tmpCvs.height = ch;
            }
        };
        window.onresize = resize;

        async function initGame() {
            sfx.init();
            sfx.playStart();
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "user", width: { ideal: 1280 }, height: { ideal: 720 } }, 
                    audio: false 
                });
                vid.srcObject = stream;
                vid.onloadedmetadata = () => {
                    vid.play();
                    resize();
                    startGameLoop();
                };
            } catch (e) {
                console.error(e);
                alert("ç„¡æ³•å•Ÿå‹•æ”å½±æ©Ÿï¼Œè«‹ç¢ºèªç€è¦½å™¨æ¬Šé™æˆ–æ˜¯ä½¿ç”¨ HTTPS é€£ç·šã€‚");
            }
        }

        function startGameLoop() {
            $('start-panel').classList.add('hidden');
            $('game-over-panel').classList.add('hidden');
            $('top-bar').style.opacity = 1;
            
            score = 0;
            lives = 3;
            items = [];
            particles = [];
            floatingTexts = [];
            
            // é‡ç½® CFG åˆ°åˆå§‹åˆºæ¿€æ¨¡å¼
            CFG.spawnRate = 12;
            
            updateUI();
            gameActive = true;
            loop();
        }

        function restartGame() {
            sfx.init(); 
            sfx.playStart();
            startGameLoop();
        }

        function toggleMute() {
            sfx.toggleMute();
        }

        function gameOver() {
            gameActive = false;
            sfx.playGameOver();
            $('final-score').innerText = score;
            $('game-over-panel').classList.remove('hidden');
            $('top-bar').style.opacity = 0;
        }

        function updateUI() {
            $('scoreDisplay').innerText = score;
            const hearts = Array(lives).fill('<i class="fas fa-heart heart"></i>').join('');
            $('livesDisplay').innerHTML = hearts;
        }

        function detectMotion() {
            if (!vid.videoWidth) return;
            tmpCtx.drawImage(vid, 0, 0, CFG.cw, ch);
            const frame = tmpCtx.getImageData(0, 0, CFG.cw, ch);
            const d = frame.data;
            
            motionPoints = [];
            mCtx.clearRect(0, 0, w, h);

            if (prevData) {
                mCtx.fillStyle = "rgba(0, 243, 255, 0.3)"; 
                for (let y = 0; y < ch; y++) {
                    for (let x = 0; x < CFG.cw; x++) {
                        const i = (y * CFG.cw + x) * 4;
                        const diff = Math.abs(d[i+1] - prevData[i+1]);
                        
                        if (diff > CFG.thresh) {
                            const visualX = x * (w / CFG.cw); 
                            const visualY = y * (h / ch);
                            mCtx.fillRect(visualX, visualY, w/CFG.cw, h/ch);
                            const gameX = (CFG.cw - x - 1) * (w / CFG.cw);
                            const gameY = visualY;
                            motionPoints.push({x: gameX, y: gameY});
                        }
                    }
                }
            }
            prevData = d; 
        }

        let frameCount = 0;
        function loop() {
            if (!gameActive) return;

            detectMotion();
            gCtx.clearRect(0, 0, w, h);

            frameCount++;
            
            // --- æ‰è½ç”Ÿæˆé‚è¼¯ä¿®æ”¹ ---
            if (frameCount % CFG.spawnRate === 0) {
                items.push(new Item());
                
                // 30% æ©Ÿç‡é¡å¤–å¤šæ‰ä¸€å€‹ (é€£æ“Š)
                if (Math.random() > 0.7) {
                    items.push(new Item());
                }
                
                // 10% æ©Ÿç‡å†å¤šæ‰ç¬¬ä¸‰å€‹ (å¤§çˆ†ç™¼)
                if (Math.random() > 0.9) {
                    items.push(new Item());
                }

                // éš¨æ™‚é–“å¢åŠ é›£åº¦ï¼Œä½†é™åˆ¶ä¸‹é™é¿å…ç•¶æ©Ÿ
                if (frameCount % 400 === 0 && CFG.spawnRate > 6) CFG.spawnRate -= 1;
            }

            // æ›´æ–°ä¸¦ç¹ªè£½æ‰è½ç‰©
            for (let i = items.length - 1; i >= 0; i--) {
                let item = items[i];
                item.update();
                item.draw(gCtx);

                let hit = false;
                if (!item.active) {
                    items.splice(i, 1);
                    continue;
                }

                for (let mp of motionPoints) {
                    const dx = item.x - mp.x;
                    const dy = item.y - mp.y;
                    if (dx*dx + dy*dy < CFG.hitRadius * CFG.hitRadius) {
                        hit = true; break;
                    }
                }

                if (hit) {
                    // --- è£œè¡€ ---
                    if (item.type === 'heart') {
                        if (lives < MAX_LIVES) { lives++; updateUI(); }
                        sfx.playHeal();
                        createExplosion(item.x, item.y, '#39ff14');
                        floatingTexts.push(new FloatingText(item.x, item.y, "è£œè¡€", "#39ff14", 30));
                    }
                    // --- ç‚¸å½ˆ ---
                    else if (item.type === 'bomb') {
                        lives--;
                        sfx.playBomb();
                        createExplosion(item.x, item.y, '#ff3b3b');
                        updateUI();
                        if (lives <= 0) gameOver();
                    } 
                    // --- å¾—åˆ† ---
                    else {
                        score += item.val;
                        let txt = "é«˜èª¿";
                        let col = "#ffd700";
                        let size = 40;

                        if (item.type === 'kao03') {
                            sfx.playSuper();
                            txt = "è¶…é«˜èª¿"; col = "#ff00ff"; size = 60;
                        } else if (item.type === 'kao02') {
                            sfx.playDiamond();
                            txt = "çœŸé«˜èª¿"; col = "#00f3ff"; size = 50;
                        } else {
                            sfx.playCoin();
                        }
                        
                        createExplosion(item.x, item.y, col);
                        // æ–°å¢æ–‡å­—ç‰¹æ•ˆ
                        floatingTexts.push(new FloatingText(item.x, item.y, txt, col, size));
                        updateUI();
                    }
                    items.splice(i, 1);
                }
            }

            // æ›´æ–°ä¸¦ç¹ªè£½ç²’å­
            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                p.update();
                p.draw(gCtx);
                if (p.life <= 0) particles.splice(i, 1);
            }

            // æ›´æ–°ä¸¦ç¹ªè£½æµ®å‹•æ–‡å­—
            for (let i = floatingTexts.length - 1; i >= 0; i--) {
                let ft = floatingTexts[i];
                ft.update();
                ft.draw(gCtx);
                if (ft.life <= 0) floatingTexts.splice(i, 1);
            }

            animationFrameId = requestAnimationFrame(loop);
        }

        function createExplosion(x, y, color) {
            for(let i=0; i<10; i++) particles.push(new Particle(x, y, color));
            gCtx.save();
            gCtx.beginPath();
            gCtx.strokeStyle = color;
            gCtx.lineWidth = 3;
            gCtx.arc(x, y, 50, 0, Math.PI*2);
            gCtx.stroke();
            gCtx.restore();
        }
    </script>
</body>
</html>